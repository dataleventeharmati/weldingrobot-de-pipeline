from __future__ import annotations

import streamlit as st

_LANG_OPTIONS = {
    "English": "en",
    "Deutsch": "de",
    "Nederlands": "nl",
    "FranÃ§ais": "fr",
    "Magyar": "hu",
}

_I18N: dict[str, dict[str, str]] = {
    "en": {
        "language": "Language",
        "app_title": "Welding Robot KPI Dashboard",
        "app_caption": "The dashboard can view 'latest' and timestamped reports (run history + trends).",
        "sidebar_report_view": "Report view",
        "select_run": "Select run (KPI)",
        "selected_kpi": "Selected KPI file:",
        "selected_dq": "Selected DQ file:",
        "selected_dd": "Drilldown file (latest):",
        "na": "n/a",
        "fallback_dq": "n/a (fallback: dq_report_latest.json, if present)",
        "dd_missing_hint": "n/a (run: report-drilldown)",
        "trends": "Trends",
        "show_trends": "Show trend charts",
        "trend_window": "Trend window (last N runs)",
        "demo_run": "Demo run (new data)",
        "demo_caption": "The button refreshes *latest* reports. Optionally saves timestamped snapshots.",
        "save_ts": "Save timestamped reports too",
        "with_dd": "Generate drilldown report too",
        "days": "Days",
        "cells": "Cells",
        "robots_per_cell": "Robots / cell",
        "random_seed": "Random seed each run",
        "seed": "Seed",
        "run_now": "Run pipeline now",
        "refresh": "Refresh",
        "before": "Before",
        "after": "After",
        "pipeline_running": "Pipeline runningâ€¦ (generate â†’ transform â†’ report-kpi",
        "kpi_time": "KPI time",
        "dq_time": "DQ time",
        "dd_time": "Drilldown time",
        "kpi_file": "KPI file",
        "dq_file": "DQ file",
        "overview": "Overview",
        "note_latest": "Note: **Run pipeline now** refreshes *latest* reports. If you're viewing a timestamped run, switch back to **Latest**, or enable timestamped saving.",
        "factory_overview": "ðŸ­ Factory overview",
        "factory_hint": "Status is computed from KPI thresholds (scrap / downtime / cycle p95).",
        "cells_count": "Cells",
        "alert_cells": "ALERT cells",
        "warning_cells": "WARNING cells",
        "scrap_by_cell": "Scrap rate by cell",
        "downtime_by_cell": "Max downtime (sec) by cell",
        "cycle_by_cell": "Cycle p95 (sec) by cell",
        "jobs_total": "Jobs total",
        "jobs_nok": "Jobs NOK",
        "scrap_rate": "Scrap rate",
        "max_downtime": "Max downtime (sec)",
        "cycle_p95": "Cycle time p95 (sec)",
        "alerts": "Alerts",
        "no_alerts": "No alerts in KPI report.",
        "top_error_codes": "Top error codes",
        "no_error_codes": "No error_code in KPI report.",
        "drilldown": "Drilldown (cell / robot)",
        "dd_missing": "Drilldown report not found: data/reports/drilldown_report_latest.json\nRun: python -m weld_pipeline.cli report-drilldown ...",
        "generated_at": "generated_at",
        "worst_offenders": "Worst offenders",
        "dq_report": "Data Quality report",
        "dq_missing": "Cannot find or read DQ report:",
        "pandas_missing": "Pandas is recommended for tables/charts (pip install pandas).",
        "no_ts_kpi": "No timestamped KPI reports in data/reports (kpi_report_YYYYmmdd_HHMMSS.json).",
        "trend_build_failed": "Could not build trend data from reports.",
        "select_cell": "Cell",
        "select_robot": "Robot (cell / robot)",
        "cell_selector": "Cell selector",
        "robot_selector": "Robot selector",
        "worst_cells": "Worst cells (scrap / downtime / cycle p95)",
        "worst_robots": "Worst robots (scrap / downtime / cycle p95)",
        "tab_scrap": "Scrap rate",
        "tab_downtime": "Max downtime",
        "tab_cycle": "Cycle p95",
        "no_per_cell": "No per_cell data.",
        "no_per_robot": "No per_robot data.",
        "no_per_cell_in_report": "No per_cell data in drilldown report.",
        "no_drill_loaded": "No drilldown report loaded. Run: python -m weld_pipeline.cli report-drilldown ...",
        "cannot_read_kpi": "Cannot find or read:",
        "run_cli_hint": "Run the pipeline to generate reports:\npython -m weld_pipeline.cli run --days 7 --cells 3 --robots 2",
        "latest_label": "Latest (kpi_report_latest.json)",
        "saved": "saved",
        "last_run_log": "Last run log",
        "factory_wall": "Factory Wall (tiles)",
        "wall_columns": "Tiles columns",
        "open_cell": "Open cell",
        "wall_details": "Details (table + charts)",
        "auto_focus": "Auto-focus worst cell on load",
    },
    "hu": {
        "language": "Nyelv",
        "app_title": "Welding Robot KPI Dashboard",
        "app_caption": "A dashboard 'latest' Ã©s a timestampelt reportokat is tudja kezelni (run history + trendek).",
        "sidebar_report_view": "Report view",
        "select_run": "VÃ¡lassz futÃ¡st (KPI)",
        "selected_kpi": "KivÃ¡lasztott KPI fÃ¡jl:",
        "selected_dq": "KivÃ¡lasztott DQ fÃ¡jl:",
        "selected_dd": "Drilldown fÃ¡jl (latest):",
        "na": "n/a",
        "fallback_dq": "n/a (fallback: dq_report_latest.json, ha lÃ©tezik)",
        "dd_missing_hint": "n/a (futtasd: report-drilldown)",
        "trends": "Trendek",
        "show_trends": "Trend chartok mutatÃ¡sa",
        "trend_window": "Trend ablak (utolsÃ³ N futÃ¡s)",
        "demo_run": "Demo run (Ãºj adatok)",
        "demo_caption": "A gomb a *latest* reportokat frissÃ­ti. OpcionÃ¡lisan timestampelt mentÃ©st is kÃ©szÃ­t.",
        "save_ts": "Save timestamped reports too",
        "with_dd": "Generate drilldown report too",
        "days": "Days",
        "cells": "Cells",
        "robots_per_cell": "Robots / cell",
        "random_seed": "Random seed minden futÃ¡snÃ¡l",
        "seed": "Seed",
        "run_now": "Run pipeline now",
        "refresh": "Refresh",
        "before": "Before",
        "after": "After",
        "pipeline_running": "Pipeline futâ€¦ (generate â†’ transform â†’ report-kpi",
        "kpi_time": "KPI time",
        "dq_time": "DQ time",
        "dd_time": "Drilldown time",
        "kpi_file": "KPI file",
        "dq_file": "DQ file",
        "overview": "Overview",
        "note_latest": "MegjegyzÃ©s: a **Run pipeline now** a *latest* reportokat frissÃ­ti. Ha timestampelt futÃ¡st nÃ©zel, vÃ¡lts vissza **Latest**-re, vagy kapcsold be a timestampelt mentÃ©st.",
        "factory_overview": "ðŸ­ Factory overview",
        "factory_hint": "StÃ¡tusz: a KPI report thresholdjai alapjÃ¡n (scrap / downtime / cycle p95).",
        "cells_count": "Cells",
        "alert_cells": "ALERT cells",
        "warning_cells": "WARNING cells",
        "scrap_by_cell": "Scrap rate by cell",
        "downtime_by_cell": "Max downtime (sec) by cell",
        "cycle_by_cell": "Cycle p95 (sec) by cell",
        "jobs_total": "Jobs total",
        "jobs_nok": "Jobs NOK",
        "scrap_rate": "Scrap rate",
        "max_downtime": "Max downtime (sec)",
        "cycle_p95": "Cycle time p95 (sec)",
        "alerts": "Alerts",
        "no_alerts": "Nincs alert a KPI reportban.",
        "top_error_codes": "Top error codes",
        "no_error_codes": "Nincs error_code a KPI reportban.",
        "drilldown": "Drilldown (cell / robot)",
        "dd_missing": "Nem talÃ¡lom a drilldown riportot: data/reports/drilldown_report_latest.json\nFuttasd: python -m weld_pipeline.cli report-drilldown ...",
        "generated_at": "generated_at",
        "worst_offenders": "Worst offenders",
        "dq_report": "Data Quality report",
        "dq_missing": "Nem talÃ¡lom vagy nem tudom beolvasni:",
        "pandas_missing": "A tÃ¡blÃ¡khoz/chartokhoz ajÃ¡nlott a pandas (pip install pandas).",
        "no_ts_kpi": "Nincs timestampelt KPI report a data/reports mappÃ¡ban (kpi_report_YYYYmmdd_HHMMSS.json).",
        "trend_build_failed": "Nem sikerÃ¼lt trend adatot Ã©pÃ­teni a reportokbÃ³l.",
        "select_cell": "Cell",
        "select_robot": "Robot (cell / robot)",
        "cell_selector": "Cell selector",
        "robot_selector": "Robot selector",
        "worst_cells": "Worst cells (scrap / downtime / cycle p95)",
        "worst_robots": "Worst robots (scrap / downtime / cycle p95)",
        "tab_scrap": "Scrap rate",
        "tab_downtime": "Max downtime",
        "tab_cycle": "Cycle p95",
        "no_per_cell": "Nincs per_cell adat.",
        "no_per_robot": "Nincs per_robot adat.",
        "no_per_cell_in_report": "Nincs per_cell adat a drilldown reportban.",
        "no_drill_loaded": "Nincs drilldown riport betÃ¶ltve. Futtasd: python -m weld_pipeline.cli report-drilldown ...",
        "cannot_read_kpi": "Nem talÃ¡lom vagy nem tudom beolvasni:",
        "run_cli_hint": "Futtasd le a pipeline-t, hogy lÃ©trejÃ¶jjenek a riportok:\npython -m weld_pipeline.cli run --days 7 --cells 3 --robots 2",
        "latest_label": "Latest (kpi_report_latest.json)",
        "saved": "saved",
        "last_run_log": "Last run log",
        "factory_wall": "GyÃ¡rfal (cell tiles)",
        "wall_columns": "Tile oszlopok",
        "open_cell": "Cell megnyitÃ¡sa",
        "wall_details": "RÃ©szletek (tÃ¡bla + chartok)",
        "auto_focus": "Auto-fÃ³kusz a legrosszabb cellre indulÃ¡skor",
    },
    # DE/NL/FR: most a meglÃ©vÅ‘ kulcsok mÅ±kÃ¶dni fognak EN fallback-kel is.
    # Ha akarod, kÃ©sÅ‘bb be tudjuk tÃ¶lteni a teljes DE/NL/FR szÃ³tÃ¡rat is kÃ¼lÃ¶n fÃ¡jlokbÃ³l.
}


def t(key: str) -> str:
    lang = st.session_state.get("lang", "en")
    return _I18N.get(lang, _I18N["en"]).get(key, _I18N["en"].get(key, key))


def language_selector() -> None:
    st.subheader(t("language"))
    default_label = "English"
    current_lang = st.session_state.get("lang", "en")
    current_label = next((k for k, v in _LANG_OPTIONS.items() if v == current_lang), default_label)
    chosen = st.selectbox("", list(_LANG_OPTIONS.keys()), index=list(_LANG_OPTIONS.keys()).index(current_label))
    st.session_state["lang"] = _LANG_OPTIONS[chosen]
